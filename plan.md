# デジタルサイネージアプリケーション仕様書

## 1. 概要

### 1.1 目的
Google Calendarのイベントを取得し、デジタルサイネージとして表示するWebアプリケーション。
QNAPサーバー上でDockerコンテナとして動作し、サイネージ端末からWebブラウザでアクセスして利用する。

### 1.2 主要機能
- Google Calendar APIを使用した複数カレンダーのイベント取得
- 今週から4週間分のカレンダー表示
- 10分ごとの自動更新
- OAuth2.0による認証と自動トークン更新

## 2. 機能要件

### 2.1 表示機能

#### 2.1.1 カレンダー表示
- **表示形式**: 月カレンダー形式（Google Calendarの月ビューと同様）
- **表示期間**: 現在週を含む4週間
- **週の開始**: 日曜日
- **解像度**: 1920x1080 (1080p)対応

#### 2.1.2 イベント表示
- **表示内容**: イベント名と開始時刻
- **終日イベント**: 各日付セルの最上部に時刻表記なしで表示
- **時間指定イベント**: 開始時刻順に縦に並べて表示
- **重複イベント**: 開始時刻が早い順に縦方向に配置

#### 2.1.3 カレンダー識別
- **色分け**: 各カレンダーを異なる色で表示
- **凡例**: カレンダー名と色の対応を表示（オプション）

#### 2.1.4 祝日表示
- **祝日カレンダー**: 専用の祝日カレンダーを参照
- **表示方法**: 
  - 日付セルの背景色を変更
  - 終日イベントとして祝日名を表示

### 2.2 データ取得機能

#### 2.2.1 Google Calendar連携
- **API**: Google Calendar API v3
- **認証**: OAuth 2.0
- **更新頻度**: 10分ごと
- **取得範囲**: 現在日から前後4週間

#### 2.2.2 複数カレンダー対応
- **設定方法**: 設定ファイル（JSON形式）
- **カレンダー情報**:
  - カレンダーID
  - 表示名
  - 表示色

### 2.3 認証機能

#### 2.3.1 OAuth認証
- **認証フロー**: OAuth 2.0 Authorization Code Flow
- **スコープ**: `https://www.googleapis.com/auth/calendar.readonly`
- **トークン管理**:
  - リフレッシュトークンの永続化
  - アクセストークンの自動更新

#### 2.3.2 Web UI認証フロー
1. **初回アクセス時**:
   - トークンが存在しない場合、自動的に `/setup` へリダイレクト
   - セットアップ画面で「Google認証」ボタンを表示

2. **認証プロセス**:
   - 認証ボタンクリック → Google OAuth画面へリダイレクト
   - ユーザーがカレンダーアクセスを許可
   - コールバックURL: `/auth/callback`
   - 認証成功後、トークンを保存してメイン画面へリダイレクト

3. **トークン更新**:
   - リフレッシュトークンを使用して自動更新
   - 更新失敗時は `/setup` へリダイレクト

### 2.4 設定管理機能

#### 2.4.1 設定管理UI
- **アクセスURL**: `/admin`
- **認証**: 簡易パスワード認証（環境変数で設定）
- **機能**:
  - カレンダー設定の編集（JSON形式）
  - 認証情報の再設定
  - システム状態の確認

#### 2.4.2 設定可能項目
- **カレンダー一覧**: ID、表示名、色の編集
- **表示設定**: 週の開始曜日、タイムゾーン
- **システム設定**: 更新間隔、ログレベル

## 3. 非機能要件

### 3.1 性能要件
- **起動時間**: 30秒以内
- **更新処理**: 5秒以内
- **メモリ使用量**: 512MB以下

### 3.2 可用性要件
- **エラーハンドリング**:
  - ネットワークエラー時の再試行（最大3回）
  - API制限到達時の適切な処理
  - 認証エラー時の通知

### 3.3 セキュリティ要件
- **アクセス制限**: LAN内からのみアクセス可能
- **認証情報保護**:
  - 環境変数または暗号化されたファイルで管理
  - Dockerイメージに含めない

### 3.4 運用要件
- **ログ出力**: 
  - アプリケーションログ
  - エラーログ
  - アクセスログ
- **ヘルスチェック**: エンドポイント提供

## 4. 技術仕様

### 4.1 アーキテクチャ
```
┌─────────────────┐     ┌──────────────────┐
│  サイネージ端末   │────▶│   QNAPサーバー    │
│  (Webブラウザ)   │     │  (Docker環境)     │
└─────────────────┘     └──────────────────┘
                               │
                               ▼
                        ┌──────────────────┐
                        │ Google Calendar  │
                        │      API         │
                        └──────────────────┘
```

### 4.2 技術スタック
- **フロントエンド**:
  - Vue 3 (Composition API)
  - TypeScript
  - Vite (ビルドツール)
  - HTML5/CSS3
  - レスポンシブデザイン不要（1080p固定）

- **バックエンド**:
  - Node.js + Express
  - TypeScript
  - Google API Client Library for Node.js
  - 静的ファイル配信もExpressで処理

- **インフラ**:
  - Docker (Alpine Linuxベース推奨)
  - Node.jsのHTTPサーバーで直接配信

### 4.3 ディレクトリ構造
```
/signage-app/
├── Dockerfile
├── docker-compose.yml
├── .env.example
├── package.json
├── config/
│   └── calendars.json
├── server/               # Expressバックエンド
│   ├── index.js
│   ├── auth/
│   ├── calendar/
│   └── utils/
├── client/               # Vue3フロントエンド
│   ├── index.html
│   ├── package.json
│   ├── vite.config.js
│   ├── src/
│   │   ├── main.js
│   │   ├── App.vue
│   │   ├── components/
│   │   ├── composables/
│   │   ├── assets/
│   │   └── styles/
│   └── public/
├── data/
│   └── tokens/
└── logs/
```

### 4.4 APIエンドポイント設計

#### 公開エンドポイント
- `GET /`: メインカレンダー画面（Vue SPA）
- `GET /api/calendar`: カレンダーイベント取得
- `GET /setup`: 初回設定画面（認証未設定時）
- `GET /auth/login`: Google OAuth開始
- `GET /auth/callback`: OAuth コールバック
- `GET /admin`: 管理画面（パスワード保護）

#### 管理用エンドポイント
- `GET /api/config`: 現在の設定取得
- `POST /api/config`: 設定更新
- `GET /api/status`: システム状態確認
- `POST /api/auth/reset`: 認証情報リセット

### 4.5 設定ファイル形式

#### calendars.json
```json
{
  "calendars": [
    {
      "id": "primary",
      "name": "メインカレンダー",
      "color": "#4285F4"
    },
    {
      "id": "japanese__ja@holiday.calendar.google.com",
      "name": "日本の祝日",
      "color": "#DB4437",
      "isHoliday": true
    }
  ],
  "display": {
    "weekStart": 0,
    "language": "ja-JP",
    "timezone": "Asia/Tokyo"
  }
}
```

#### .env.example
```bash
# Google OAuth設定
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
GOOGLE_REDIRECT_URI=http://localhost:3000/auth/callback

# サーバー設定
PORT=3000
NODE_ENV=production

# 管理画面設定
ADMIN_PASSWORD=your-admin-password

# ログ設定
LOG_LEVEL=info
```

## 5. 画面設計

### 5.1 メイン画面（カレンダービュー）
```
┌─────────────────────────────────────────────────────┐
│                    [現在の年月]                       │
├─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│ 日  │ 月  │ 火  │ 水  │ 木  │ 金  │ 土  │
├─────┼─────┼─────┼─────┼─────┼─────┼─────┤
│  1  │  2  │  3  │  4  │  5  │  6  │  7  │
│     │終日 │     │     │終日 │     │     │
│     │会議 │     │     │祝日 │     │     │
│     │10:00│     │     │     │     │     │
│     │定例 │     │     │     │     │     │
├─────┼─────┼─────┼─────┼─────┼─────┼─────┤
│  8  │  9  │ ... │     │     │     │     │
│     │     │     │     │     │     │     │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┘
                    [最終更新: HH:MM]
```

### 5.2 セットアップ画面
```
┌─────────────────────────────────────────────────────┐
│                 初回セットアップ                      │
├─────────────────────────────────────────────────────┤
│                                                     │
│   Google Calendar と連携するために認証が必要です      │
│                                                     │
│        [ Google アカウントで認証する ]               │
│                                                     │
│   ※ カレンダーの読み取り権限のみ要求します           │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 5.3 管理画面（/admin）
```
┌─────────────────────────────────────────────────────┐
│                    設定管理                          │
├─────────────────────────────────────────────────────┤
│ カレンダー設定:                                      │
│ ┌─────────────────────────────────────────────┐   │
│ │{                                               │   │
│ │  "calendars": [                                │   │
│ │    {                                           │   │
│ │      "id": "primary",                          │   │
│ │      "name": "メインカレンダー",                │   │
│ │      "color": "#4285F4"                        │   │
│ │    }                                           │   │
│ │  ]                                             │   │
│ │}                                               │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
│ [ 保存 ] [ Google認証をリセット ]                    │
│                                                     │
│ システム状態: 正常 | 最終更新: 2024-01-20 10:30      │
└─────────────────────────────────────────────────────┘
```

### 5.4 デザイン要件
- **フォント**: Noto Sans CJK Japanese
- **文字サイズ**: 
  - 日付: 24px
  - イベント名: 16px
  - 時刻: 14px
- **配色**:
  - 背景: 白 (#FFFFFF)
  - 文字: 黒 (#333333)
  - 土曜: 青系 (#0066CC)
  - 日曜・祝日: 赤系 (#CC0000)

## 6. 実装手順

### 6.1 フェーズ1: 基本機能実装
1. プロジェクト構造の作成
   - Express サーバーのセットアップ
   - Vue3 プロジェクトの初期化（Vite使用）
   - 開発環境の構築
2. Google Calendar API認証の実装
   - OAuth2クライアントの設定
   - 認証フローの実装
   - トークン管理機能
3. カレンダーデータ取得機能
   - Express APIエンドポイントの作成
   - Google Calendar APIとの連携
4. 基本的なカレンダー表示
   - Vue3でカレンダーコンポーネント作成
   - APIとの通信処理

### 6.2 フェーズ2: 表示機能拡張
1. 複数カレンダー対応
2. 色分け機能
3. 祝日表示
4. 自動更新機能

### 6.3 フェーズ3: 運用機能追加
1. 設定ファイル管理
2. ログ機能
3. エラーハンドリング
4. Docker化

## 7. テスト計画

### 7.1 単体テスト
- API認証処理
- カレンダーデータ取得
- 日付計算処理

### 7.2 結合テスト
- 複数カレンダー統合表示
- 自動更新機能
- エラー復旧処理

### 7.3 システムテスト
- 24時間連続動作
- ネットワーク断線・復旧
- トークン期限切れ対応

## 8. 運用・保守

### 8.1 初期設定手順
1. Google Cloud Consoleでプロジェクト作成
2. Calendar APIの有効化
3. OAuth 2.0認証情報の作成
4. 設定ファイルの編集
5. Dockerイメージのビルド・デプロイ

### 8.2 日常運用
- ログ監視
- カレンダー追加・削除時の設定更新
- 定期的なDockerイメージ更新

### 8.3 トラブルシューティング
- 認証エラー時の対応
- 表示不具合の確認手順
- ログ解析方法

## 9. 制約事項

1. インターネット接続が必須
2. Google Calendar APIの利用制限に準拠
3. 1080p固定解像度（レスポンシブ非対応）
4. 日本語環境のみ対応
5. 読み取り専用（カレンダー編集機能なし）

## 10. 今後の拡張案

1. 天気情報の表示
2. ニュースティッカー機能
3. 複数レイアウトテンプレート
4. 管理用Web UIの機能拡張（現在は簡易版）